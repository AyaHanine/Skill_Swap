{% extends 'base.html.twig' %}

{% block title %}Conversation{% endblock %}

{% block body %}
{{ dump("TEMPLATE CHARG√â") }}

    <h1>Conversation {{ conversation.id }}</h1>
    
    <div id="messages">
        {% for message in messages %}
            <p><strong>{{ message.sender.lastName ?? 'Utilisateur inconnu' }}</strong>: {{ message.content }}</p>
        {% endfor %}
    </div>

    {{ form_start(form) }}
        {{ form_row(form.content) }}
        <button type="submit">Envoyer</button>
    {{ form_end(form) }}


<script>
    document.addEventListener("DOMContentLoaded", function() {
        console.log("üöÄ Script JS charg√©");



        {% if conversation is defined and conversation.id is defined %}
            const conversationId = "{{ conversation.id }}";
            const topic = `http://localhost:8000/chat/${conversationId}`;

            console.log("‚úÖ Connexion Mercure : Chat pour la conversation {{ conversation.id }}");
            console.log("üîç Topic Mercure :", topic);

            const eventSource = new EventSource("http://localhost:3000/.well-known/mercure?topic=http://localhost:8000/chat/1");

            eventSource.onopen = function() {
                console.log("‚úÖ Connexion √©tablie avec Mercure !");
            };

            eventSource.onmessage = function(event) {
                console.log("üì© Message re√ßu :", event.data);

                const data = JSON.parse(event.data);
                const messagesContainer = document.querySelector("#messages");

                messagesContainer.innerHTML += `
                    <p><strong>${data.sender}</strong>: ${data.message} <small>${data.createdAt}</small></p>
                `;
            };

            eventSource.onerror = function(event) {
                console.error("‚ùå Erreur Mercure :", event);
            };
        {% else %}
            console.error("‚ùå Erreur : La variable conversation n'est pas d√©finie.");
        {% endif %}
    });
</script>


{% endblock %}


